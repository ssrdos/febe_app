<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Alumnos - Escuela de Padel Febe Ruiz</title>
    <link rel="icon" type="image/png" href="media/tenis.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
    <script type="module" src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="js/theme.js"></script>
</head>
<body>
    <div class="list-container">
        <h1 class="form-title">LISTA DE ALUMNOS</h1>
        
        <!-- Counter section -->
        <div class="counter-container">
            <div class="counter-item">
                <span class="counter-number" id="totalCounter">0</span>
                <span class="counter-label">Total Alumnos</span>
            </div>
            <div class="counter-item">
                <span class="counter-number" id="paidCounter">0</span>
                <span class="counter-label">Abonados</span>
            </div>
            <div class="counter-item">
                <span class="counter-number" id="unpaidCounter">0</span>
                <span class="counter-label">No Abonados</span>
            </div>
        </div>

        <div class="filter-container">
            <!-- Add payment status filter -->
            <div class="filter-group">
                <label class="filter-label">Estado de pago:</label>
                <select id="paymentStatusFilter" class="form-input">
                    <option value="">Todos</option>
                    <option value="abonado">Abonados</option>
                    <option value="no_abonado">No Abonados</option>
                </select>
            </div>
            
            <!-- Existing search input -->
            <input type="text" 
                   id="searchInput" 
                   class="form-input search-input" 
                   placeholder="Buscar por nombre o apellido...">
            
            <!-- Existing delete all button -->
            <button type="button" 
                    class="btn-delete-all" 
                    onclick="deleteAllStudents()">
                ELIMINAR TODOS
            </button>
            <button type="button" 
                    class="btn-export" 
                    onclick="exportToExcel()">
                EXPORTAR A EXCEL
            </button>
        </div>
        <div class="students-list" id="studentsList">
            <!-- Lista de alumnos se generará aquí -->
        </div>
        <div id="studentDetail" class="student-detail" style="display: none;">
            <h2 class="detail-title">DETALLES DEL ALUMNO</h2>
            <div class="detail-content"></div>
            <div class="detail-actions">
                <button type="button" class="btn-volver" onclick="closeDetail()">VOLVER</button>
            </div>
        </div>
        <div class="detail-actions">
            <button type="button" class="btn-volver" onclick="window.location.href='menu.html'">VOLVER AL MENÚ</button>
        </div>
    </div>

    <script type="module">
        import { db } from './js/firebase-config.js';
        import { auth } from './js/firebase-config.js';
        import { ref, get, remove, set } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js';
        import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
        import { checkAuth } from './js/auth.js';

        // Verificar autenticación antes de cargar datos
        checkAuth();

        window.onload = async function() {
            // Esperar a que el usuario esté autenticado antes de cargar datos
            await new Promise((resolve) => {
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        resolve(user);
                    } else {
                        // Si no hay usuario, checkAuth ya redirigirá
                        // Pero esperamos un poco para dar tiempo a la redirección
                        setTimeout(() => resolve(null), 100);
                    }
                });
            });
            
            // Si no hay usuario autenticado, no continuar
            if (!auth.currentUser) {
                console.log('Usuario no autenticado, esperando redirección...');
                return;
            }
            const studentsList = document.getElementById('studentsList');
            const searchInput = document.getElementById('searchInput');
            const paymentStatusFilter = document.getElementById('paymentStatusFilter');
            const studentDetail = document.getElementById('studentDetail');
            let students = [];
            
            // Verificar que los elementos existan
            if (!studentsList) {
                console.error('Error: No se encontró el elemento studentsList');
                return;
            }
            
            // Mostrar mensaje de carga
            studentsList.innerHTML = '<p class="no-students">Cargando alumnos...</p>';

            // Function to render the table
            function renderTable(students) {
                if (students.length === 0) {
                    studentsList.innerHTML = '<p class="no-students">No hay alumnos registrados</p>';
                    return;
                }

                let html = '<table class="students-table">';
                html += `
                    <tr>
                        <th>Nombre</th>
                        <th>Apellido</th>
                        <th>Método de Pago</th>
                        <th>Fecha de Pago</th>
                        <th>Acciones</th>
                    </tr>`;

                students.forEach((student, index) => {
                    // Format the payment date
                    const fechaPago = student.fechaPago ? 
                        new Date(student.fechaPago).toLocaleDateString('es-AR', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit'
                        }) : 'No registrado';

                    // Safely format metodoPago
                    const metodoPago = student.metodoPago ? String(student.metodoPago).toUpperCase() : 'NO ESPECIFICADO';
                    
                    html += `
                        <tr>
                            <td>${student.nombre || 'No especificado'}</td>
                            <td>${student.apellido || 'No especificado'}</td>
                            <td>${metodoPago}</td>
                            <td>${fechaPago}</td>
                            <td>
                                <button onclick="viewStudent(${index})" class="btn-view">VER</button>
                                <button onclick="deleteStudent(${index})" class="btn-delete">ELIMINAR</button>
                            </td>
                        </tr>`;
                });

                html += '</table>';
                studentsList.innerHTML = html;
            }

            // Function to load students from Firebase
            async function loadStudents() {
                try {
                    console.log('Cargando alumnos desde Firebase...');
                    const studentsRef = ref(db, 'students');
                    const snapshot = await get(studentsRef);
                    let totalStudents = 0;
                    let paidStudents = 0;
                    let unpaidStudents = 0;

                    if (snapshot.exists()) {
                        students = [];
                        snapshot.forEach((childSnapshot) => {
                            const student = {
                                id: childSnapshot.key,
                                ...childSnapshot.val()
                            };
                            students.push(student);
                            totalStudents++;
                            if (student.metodoPago === 'no_abonado') {
                                unpaidStudents++;
                            } else {
                                paidStudents++;
                            }
                        });
                        console.log(`Se cargaron ${totalStudents} alumnos`);
                    } else {
                        console.log('No hay alumnos en la base de datos');
                        students = [];
                    }

                    // Update counters
                    const totalCounterEl = document.getElementById('totalCounter');
                    const paidCounterEl = document.getElementById('paidCounter');
                    const unpaidCounterEl = document.getElementById('unpaidCounter');
                    
                    if (totalCounterEl) totalCounterEl.textContent = totalStudents;
                    if (paidCounterEl) paidCounterEl.textContent = paidStudents;
                    if (unpaidCounterEl) unpaidCounterEl.textContent = unpaidStudents;

                    return students;
                } catch (error) {
                    console.error('Error loading students:', error);
                    console.error('Error details:', {
                        code: error.code,
                        message: error.message,
                        stack: error.stack
                    });
                    
                    // Verificar si es un error de permisos
                    let errorMessage = 'Error al cargar los alumnos';
                    if (error.code === 'PERMISSION_DENIED') {
                        errorMessage = 'No tienes permiso para acceder a los datos. Por favor, verifica que estés autenticado correctamente.';
                        console.error('Error de permisos - verificar reglas de Firebase y autenticación');
                    } else if (error.message) {
                        errorMessage = `Error al cargar los alumnos: ${error.message}`;
                    }
                    
                    // Mostrar error al usuario
                    if (window.customError) {
                        await window.customError(errorMessage, 'Error');
                    } else {
                        alert(errorMessage);
                    }
                    
                    // Mostrar mensaje en la página también
                    const studentsListEl = document.getElementById('studentsList');
                    if (studentsListEl) {
                        studentsListEl.innerHTML = `<p class="no-students" style="color: #dc2626;">${errorMessage}</p>`;
                    }
                    
                    return [];
                }
            }

            // Keep track of filtered students
            let filteredStudents = [];

            function filterStudents() {
                const searchTerm = searchInput.value.toLowerCase();
                const paymentStatus = paymentStatusFilter.value;
                
                filteredStudents = [...students]; // Create a copy of all students

                // Filter by payment status
                if (paymentStatus) {
                    filteredStudents = filteredStudents.filter(student => {
                        if (paymentStatus === 'abonado') {
                            return student.metodoPago !== 'no_abonado';
                        } else {
                            return student.metodoPago === 'no_abonado';
                        }
                    });
                }

                // Filter by search term
                if (searchTerm) {
                    filteredStudents = filteredStudents.filter(student => {
                        const fullName = `${student.nombre} ${student.apellido}`.toLowerCase();
                        return fullName.includes(searchTerm);
                    });
                }

                renderTable(filteredStudents);
            }

            // Initialize and render students
            try {
                console.log('Inicializando lista de alumnos...');
                students = await loadStudents();
                console.log(`Total de alumnos cargados: ${students.length}`);
                
                if (students.length === 0) {
                    studentsList.innerHTML = '<p class="no-students">No hay alumnos registrados</p>';
                } else {
                    filterStudents(); // Use filterStudents instead of renderTable
                }
            } catch (error) {
                console.error('Error initializing students:', error);
                console.error('Error details:', error);
                
                let errorMessage = 'Error al cargar los alumnos';
                if (error.message) {
                    errorMessage += `: ${error.message}`;
                }
                
                studentsList.innerHTML = `<p class="no-students" style="color: #dc2626;">${errorMessage}</p>`;
                
                if (window.customError) {
                    await window.customError(errorMessage, 'Error');
                }
            }

            // Update counters
            function updateCounters() {
                const totalCounter = document.getElementById('totalCounter');
                const paidCounter = document.getElementById('paidCounter');
                const unpaidCounter = document.getElementById('unpaidCounter');

                if (totalCounter) totalCounter.innerText = students.length;
                if (paidCounter) paidCounter.innerText = students.filter(s => s.metodoPago !== 'no_abonado').length;
                if (unpaidCounter) unpaidCounter.innerText = students.filter(s => s.metodoPago === 'no_abonado').length;
            }

            // Search functionality
            searchInput.addEventListener('input', () => {
                filterStudents();
                updateCounters();
            });

            // Filter by payment status
            paymentStatusFilter.addEventListener('change', () => {
                filterStudents();
                updateCounters();
            });

            // Make functions available globally
            window.viewStudent = async function(index) {
                // Use the filtered array instead of the main array
                const student = filteredStudents[index];
                
                if (!student) {
                    if (window.customError) {
                        await window.customError('Error: No se pudo encontrar la información del alumno', 'Error');
                    } else {
                        alert('Error: No se pudo encontrar la información del alumno');
                    }
                    console.error('Student not found at index:', index);
                    return;
                }
                
                studentsList.style.display = 'none';
                studentDetail.style.display = 'block';
                
                // Helper function to safely format arrays
                const formatArray = (field) => {
                    if (!field) return 'No especificado';
                    if (Array.isArray(field)) {
                        return field.length > 0 ? field.join(', ') : 'No especificado';
                    }
                    return String(field);
                };
                
                // Helper function to safely format date
                const formatDate = (dateField) => {
                    if (!dateField) return 'No registrado';
                    try {
                        const date = new Date(dateField);
                        return date.toLocaleDateString('es-AR', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit'
                        });
                    } catch (e) {
                        return 'Fecha inválida';
                    }
                };
                
                const detailHtml = `
                    <div class="detail-item">
                        <strong>Nombre:</strong> ${student.nombre || 'No especificado'}
                    </div>
                    <div class="detail-item">
                        <strong>Apellido:</strong> ${student.apellido || 'No especificado'}
                    </div>
                    <div class="detail-item">
                        <strong>Días:</strong> ${formatArray(student.dias)}
                    </div>
                    <div class="detail-item">
                        <strong>Turnos:</strong> ${formatArray(student.turnos)}
                    </div>
                    <div class="detail-item">
                        <strong>Horarios:</strong> ${formatArray(student.horarios)}
                    </div>
                    <div class="detail-item">
                        <strong>Cuota:</strong> $${student.cuota || '0'}
                    </div>
                    <div class="detail-item">
                        <strong>Mes/Año:</strong> ${student.mesAnio || 'No especificado'}
                    </div>
                    <div class="detail-item">
                        <strong>Método de Pago:</strong> ${student.metodoPago ? student.metodoPago.toUpperCase() : 'No especificado'}
                    </div>
                    <div class="detail-item">
                        <strong>Fecha de Pago:</strong> ${formatDate(student.fechaPago)}
                    </div>
                    <div class="detail-actions">
                        <button onclick="editStudent(${index})" class="btn-edit">Editar</button>
                        <button onclick="deleteStudent(${index})" class="btn-delete">Eliminar</button>
                    </div>`;
                
                document.querySelector('.detail-content').innerHTML = detailHtml;
            };

            window.closeDetail = function() {
                studentDetail.style.display = 'none';
                studentsList.style.display = 'block';
            };

            window.editStudent = async function(index) {
                // Use the filtered array
                const student = filteredStudents[index];
                if (!student) {
                    console.error('Student not found');
                    if (window.customError) {
                        await window.customError('Error: No se pudo encontrar la información del alumno', 'Error');
                    } else {
                        alert('Error: No se pudo encontrar la información del alumno');
                    }
                    return;
                }

                const detailContent = document.querySelector('.detail-content');
                
                // Helper function to safely format arrays for editing
                const formatArrayForEdit = (field) => {
                    if (!field) return '';
                    if (Array.isArray(field)) {
                        return field.join(', ');
                    }
                    return String(field);
                };
                
                // Helper function to safely format date for input
                const formatDateForInput = (dateField) => {
                    if (!dateField) return '';
                    try {
                        // Handle both ISO string and timestamp formats
                        let date;
                        if (typeof dateField === 'number') {
                            date = new Date(dateField);
                        } else {
                            date = new Date(dateField);
                        }
                        if (isNaN(date.getTime())) return '';
                        return date.toISOString().slice(0, 10);
                    } catch (e) {
                        return '';
                    }
                };
                
                const editHtml = `
                    <div class="detail-item">
                        <strong>Nombre:</strong>
                        <input type="text" class="detail-edit-input" value="${student.nombre || ''}" id="edit-nombre">
                    </div>
                    <div class="detail-item">
                        <strong>Apellido:</strong>
                        <input type="text" class="detail-edit-input" value="${student.apellido || ''}" id="edit-apellido">
                    </div>
                    <div class="detail-item">
                        <strong>Días:</strong>
                        <input type="text" class="detail-edit-input" value="${formatArrayForEdit(student.dias)}" id="edit-dias">
                    </div>
                    <div class="detail-item">
                        <strong>Turnos:</strong>
                        <input type="text" class="detail-edit-input" value="${formatArrayForEdit(student.turnos)}" id="edit-turnos">
                    </div>
                    <div class="detail-item">
                        <strong>Horarios:</strong>
                        <input type="text" class="detail-edit-input" value="${formatArrayForEdit(student.horarios)}" id="edit-horarios">
                    </div>
                    <div class="detail-item">
                        <strong>Cuota:</strong>
                        <input type="number" class="detail-edit-input" value="${student.cuota || ''}" id="edit-cuota">
                    </div>
                    <div class="detail-item">
                        <strong>Fecha de Pago:</strong>
                        <input type="date" 
                               class="detail-edit-input" 
                               value="${formatDateForInput(student.fechaPago)}" 
                               id="edit-fechaPago">
                    </div>
                    <div class="detail-item">
                        <strong>Método de Pago:</strong>
                        <select class="detail-edit-input" id="edit-metodoPago">
                            <option value="efectivo" ${student.metodoPago === 'efectivo' ? 'selected' : ''}>EFECTIVO</option>
                            <option value="transferencia" ${student.metodoPago === 'transferencia' ? 'selected' : ''}>TRANSFERENCIA</option>
                            <option value="ambas" ${student.metodoPago === 'ambas' ? 'selected' : ''}>AMBAS</option>
                            <option value="no_abonado" ${student.metodoPago === 'no_abonado' ? 'selected' : ''}>NO ABONADO</option>
                        </select>
                    </div>
                    <div class="detail-actions">
                        <button onclick="saveChanges('${student.id}')" class="btn-save">Guardar</button>
                        <button onclick="cancelEdit(${index})" class="btn-volver">Cancelar</button>
                    </div>`;
                
                detailContent.innerHTML = editHtml;
            };

            // También actualiza la función saveChanges para usar el ID
            window.saveChanges = async function(studentId) {
                // Get form values safely
                const nombreValue = document.getElementById('edit-nombre')?.value || '';
                const apellidoValue = document.getElementById('edit-apellido')?.value || '';
                const diasValue = document.getElementById('edit-dias')?.value || '';
                const turnosValue = document.getElementById('edit-turnos')?.value || '';
                const horariosValue = document.getElementById('edit-horarios')?.value || '';
                const cuotaValue = document.getElementById('edit-cuota')?.value || '';
                const fechaPagoValue = document.getElementById('edit-fechaPago')?.value || '';
                const metodoPagoValue = document.getElementById('edit-metodoPago')?.value || 'no_abonado';
                
                // Process arrays safely
                const dias = diasValue ? diasValue.split(',').map(d => d.trim()).filter(d => d.length > 0) : [];
                const turnos = turnosValue ? turnosValue.split(',').map(t => t.trim()).filter(t => t.length > 0) : [];
                const horarios = horariosValue ? horariosValue.split(',').map(h => h.trim()).filter(h => h.length > 0) : [];
                
                // Calculate mesAnio safely
                let mesAnio = '';
                if (fechaPagoValue) {
                    try {
                        const fecha = new Date(fechaPagoValue);
                        if (!isNaN(fecha.getTime())) {
                            mesAnio = fecha.toISOString().slice(0, 7);
                        }
                    } catch (e) {
                        console.error('Error parsing date:', e);
                    }
                }
                
                const student = {
                    nombre: nombreValue,
                    apellido: apellidoValue,
                    dias: dias,
                    turnos: turnos,
                    horarios: horarios,
                    cuota: cuotaValue || '0',
                    fechaPago: fechaPagoValue || null,
                    mesAnio: mesAnio,
                    metodoPago: metodoPagoValue,
                    timestamp: Date.now()
                };

                try {
                    await set(ref(db, `students/${studentId}`), student);
                    students = await loadStudents();
                    filteredStudents = [...students]; // Update filtered array
                    filterStudents(); // Apply current filters
                    const index = filteredStudents.findIndex(s => s.id === studentId);
                    if (index !== -1) {
                        viewStudent(index);
                    } else {
                        closeDetail();
                    }
                    if (window.customSuccess) {
                        await window.customSuccess('Cambios guardados correctamente', 'Éxito');
                    } else {
                        alert('Cambios guardados correctamente');
                    }
                } catch (error) {
                    console.error('Error saving changes:', error);
                    if (window.customError) {
                        await window.customError('Error al guardar los cambios', 'Error');
                    } else {
                        alert('Error al guardar los cambios');
                    }
                }
            };

            window.cancelEdit = function(index) {
                viewStudent(index);
            };

            window.deleteStudent = async function(index) {
                const confirmed = window.customConfirm 
                    ? await window.customConfirm('¿Está seguro que desea eliminar este alumno?', 'Eliminar Alumno')
                    : confirm('¿Está seguro que desea eliminar este alumno?');
                
                if (confirmed) {
                    // Use the filtered array
                    const student = filteredStudents[index];
                    try {
                        await remove(ref(db, `students/${student.id}`));
                        students = await loadStudents();
                        filteredStudents = [...students]; // Update filtered array
                        closeDetail();
                        filterStudents(); // Use filterStudents instead of renderTable
                        if (window.customSuccess) {
                            await window.customSuccess('Alumno eliminado correctamente', 'Éxito');
                        } else {
                            alert('Alumno eliminado correctamente');
                        }
                    } catch (error) {
                        console.error('Error deleting student:', error);
                        if (window.customError) {
                            await window.customError('Error al eliminar el alumno', 'Error');
                        } else {
                            alert('Error al eliminar el alumno');
                        }
                    }
                }
            };

            window.deleteAllStudents = async function() {
                const confirmed = window.customConfirm 
                    ? await window.customConfirm('¿Está seguro que desea eliminar todos los alumnos? Esta acción no se puede deshacer.', 'Eliminar Todos')
                    : confirm('¿Está seguro que desea eliminar todos los alumnos?');
                
                if (confirmed) {
                    try {
                        await remove(ref(db, 'students'));
                        students = [];
                        renderTable(students);
                        if (window.customSuccess) {
                            await window.customSuccess('Todos los alumnos han sido eliminados correctamente', 'Éxito');
                        } else {
                            alert('Todos los alumnos han sido eliminados correctamente');
                        }
                    } catch (error) {
                        console.error('Error deleting all students:', error);
                        if (window.customError) {
                            await window.customError('Error al eliminar todos los alumnos', 'Error');
                        } else {
                            alert('Error al eliminar todos los alumnos');
                        }
                    }
                }
            };

            window.exportToExcel = async function() {
                try {
                    // Create worksheet data with updated headers
                    const wsData = [
                        ['Nombre', 'Apellido', 'Días', 'Turnos', 'Horarios', 'Cuota', 'Método de Pago', 'Fecha de Pago']
                    ];

                    students.forEach(student => {
                        // Format the payment date for Excel
                        let fechaPago = 'No registrado';
                        if (student.fechaPago) {
                            try {
                                const date = new Date(student.fechaPago);
                                if (!isNaN(date.getTime())) {
                                    fechaPago = date.toLocaleDateString('es-AR', {
                                        year: 'numeric',
                                        month: '2-digit',
                                        day: '2-digit'
                                    });
                                }
                            } catch (e) {
                                fechaPago = 'Fecha inválida';
                            }
                        }

                        // Safely format arrays
                        const formatArrayField = (field) => {
                            if (!field) return '';
                            if (Array.isArray(field)) {
                                return field.length > 0 ? field.join(', ') : '';
                            }
                            return String(field);
                        };

                        wsData.push([
                            student.nombre || '',
                            student.apellido || '',
                            formatArrayField(student.dias),
                            formatArrayField(student.turnos),
                            formatArrayField(student.horarios),
                            student.cuota || '0',
                            student.metodoPago ? String(student.metodoPago).toUpperCase() : 'NO ESPECIFICADO',
                            fechaPago
                        ]);
                    });

                    // Create workbook
                    const wb = XLSX.utils.book_new();
                    const ws = XLSX.utils.aoa_to_sheet(wsData);

                    // Add column widths for better readability
                    const colWidths = [
                        {wch: 15}, // Nombre
                        {wch: 15}, // Apellido
                        {wch: 20}, // Días
                        {wch: 20}, // Turnos
                        {wch: 20}, // Horarios
                        {wch: 10}, // Cuota
                        {wch: 15}, // Método de Pago
                        {wch: 20}  // Fecha y Hora de Pago
                    ];
                    ws['!cols'] = colWidths;

                    // Add worksheet to workbook
                    XLSX.utils.book_append_sheet(wb, ws, 'Alumnos');

                    // Generate filename with current date
                    const date = new Date().toISOString().split('T')[0];
                    const fileName = `alumnos_${date}.xlsx`;

                    // Save file
                    XLSX.writeFile(wb, fileName);
                } catch (error) {
                    console.error('Error exporting to Excel:', error);
                    if (window.customError) {
                        await window.customError('Error al exportar a Excel', 'Error');
                    } else {
                        alert('Error al exportar a Excel');
                    }
                }
            };
        }
    </script>
    <script src="js/custom-alert.js"></script>
    <script src="js/alert-helpers.js"></script>
    <script type="module" src="js/theme.js"></script>
    <script src="js/navigation.js"></script>
</body>
</html>